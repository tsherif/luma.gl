{"version":3,"sources":["../../../src/gltf/gltf-animator.js"],"names":["Matrix4","ATTRIBUTE_TYPE_TO_COMPONENTS","SCALAR","VEC2","VEC3","VEC4","MAT2","MAT3","MAT4","ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY","Int8Array","Uint8Array","Int16Array","Uint16Array","Uint32Array","Float32Array","accessorToJsArray","accessor","_animation","ArrayType","componentType","components","type","length","count","bufferView","data","buffer","byteOffset","array","Array","from","slicedArray","i","push","slice","helperMatrix","applyTranslationRotationScale","gltfNode","node","matrix","identity","translation","translate","rotation","rotationMatrix","fromQuaternion","multiplyRight","scale","GLTFAnimation","constructor","props","startTime","playing","speed","Object","assign","animate","timeMs","absTime","time","channels","forEach","sampler","input","output","target","path","index","findIndex","t","_node","GLTFAnimator","gltf","animations","map","animation","name","samplers","interpolation","accessors","nodes","getAnimations"],"mappings":"AAAA,SAAQA,OAAR,QAAsB,SAAtB;AAGA,OAAO,MAAMC,4BAA4B,GAAG;AAC1CC,EAAAA,MAAM,EAAE,CADkC;AAE1CC,EAAAA,IAAI,EAAE,CAFoC;AAG1CC,EAAAA,IAAI,EAAE,CAHoC;AAI1CC,EAAAA,IAAI,EAAE,CAJoC;AAK1CC,EAAAA,IAAI,EAAE,CALoC;AAM1CC,EAAAA,IAAI,EAAE,CANoC;AAO1CC,EAAAA,IAAI,EAAE;AAPoC,CAArC;AAUP,OAAO,MAAMC,iCAAiC,GAAG;AAC/C,QAAMC,SADyC;AAE/C,QAAMC,UAFyC;AAG/C,QAAMC,UAHyC;AAI/C,QAAMC,WAJyC;AAK/C,QAAMC,WALyC;AAM/C,QAAMC;AANyC,CAA1C;;AAUP,SAASC,iBAAT,CAA2BC,QAA3B,EAAqC;AACnC,MAAI,CAACA,QAAQ,CAACC,UAAd,EAA0B;AACxB,UAAMC,SAAS,GAAGV,iCAAiC,CAACQ,QAAQ,CAACG,aAAV,CAAnD;AACA,UAAMC,UAAU,GAAGpB,4BAA4B,CAACgB,QAAQ,CAACK,IAAV,CAA/C;AACA,UAAMC,MAAM,GAAGF,UAAU,GAAGJ,QAAQ,CAACO,KAArC;AAHwB,kCAIKP,QAAQ,CAACQ,UAAT,CAAoBC,IAJzB;AAAA,UAIjBC,MAJiB,yBAIjBA,MAJiB;AAAA,UAITC,UAJS,yBAITA,UAJS;AAMxB,UAAMC,KAAK,GAAG,IAAIV,SAAJ,CAAcQ,MAAd,EAAsBC,UAAU,IAAIX,QAAQ,CAACW,UAAT,IAAuB,CAA3B,CAAhC,EAA+DL,MAA/D,CAAd;;AAEA,QAAIF,UAAU,KAAK,CAAnB,EAAsB;AACpBJ,MAAAA,QAAQ,CAACC,UAAT,GAAsBY,KAAK,CAACC,IAAN,CAAWF,KAAX,CAAtB;AACD,KAFD,MAEO;AAEL,YAAMG,WAAW,GAAG,EAApB;;AACA,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,KAAK,CAACN,MAA1B,EAAkCU,CAAC,IAAIZ,UAAvC,EAAmD;AACjDW,QAAAA,WAAW,CAACE,IAAZ,CAAiBJ,KAAK,CAACC,IAAN,CAAWF,KAAK,CAACM,KAAN,CAAYF,CAAZ,EAAeA,CAAC,GAAGZ,UAAnB,CAAX,CAAjB;AACD;;AACDJ,MAAAA,QAAQ,CAACC,UAAT,GAAsBc,WAAtB;AACD;AACF;;AAED,SAAOf,QAAQ,CAACC,UAAhB;AACD;;AAGD,MAAMkB,YAAY,GAAG,IAAIpC,OAAJ,EAArB;;AACA,SAASqC,6BAAT,CAAuCC,QAAvC,EAAiDC,IAAjD,EAAuD;AACrDA,EAAAA,IAAI,CAACC,MAAL,CAAYC,QAAZ;;AAEA,MAAIH,QAAQ,CAACI,WAAb,EAA0B;AACxBH,IAAAA,IAAI,CAACC,MAAL,CAAYG,SAAZ,CAAsBL,QAAQ,CAACI,WAA/B;AACD;;AAED,MAAIJ,QAAQ,CAACM,QAAb,EAAuB;AACrB,UAAMC,cAAc,GAAGT,YAAY,CAACU,cAAb,CAA4BR,QAAQ,CAACM,QAArC,CAAvB;AACAL,IAAAA,IAAI,CAACC,MAAL,CAAYO,aAAZ,CAA0BF,cAA1B;AACD;;AAED,MAAIP,QAAQ,CAACU,KAAb,EAAoB;AAClBT,IAAAA,IAAI,CAACC,MAAL,CAAYQ,KAAZ,CAAkBV,QAAQ,CAACU,KAA3B;AACD;AACF;;AAED,MAAMC,aAAN,CAAoB;AAClBC,EAAAA,WAAW,CAACC,KAAD,EAAQ;AACjB,SAAKC,SAAL,GAAiB,CAAjB;AACA,SAAKC,OAAL,GAAe,IAAf;AACA,SAAKC,KAAL,GAAa,CAAb;AAEAC,IAAAA,MAAM,CAACC,MAAP,CAAc,IAAd,EAAoBL,KAApB;AACD;;AAEDM,EAAAA,OAAO,CAACC,MAAD,EAAS;AACd,QAAI,CAAC,KAAKL,OAAV,EAAmB;AACjB;AACD;;AAED,UAAMM,OAAO,GAAGD,MAAM,GAAG,IAAzB;AACA,UAAME,IAAI,GAAG,CAACD,OAAO,GAAG,KAAKP,SAAhB,IAA6B,KAAKE,KAA/C;AAEA,SAAKO,QAAL,CAAcC,OAAd,CAAsB,UAA8C;AAAA,8BAA5CC,OAA4C;AAAA,UAAlCC,KAAkC,gBAAlCA,KAAkC;AAAA,UAA3BC,MAA2B,gBAA3BA,MAA2B;AAAA,UAAlBC,MAAkB,QAAlBA,MAAkB;AAAA,UAAVC,IAAU,QAAVA,IAAU;AAElE,UAAIC,KAAK,GAAGJ,KAAK,CAACK,SAAN,CAAgBC,CAAC,IAAIA,CAAC,GAAGV,IAAzB,CAAZ;;AACA,UAAIQ,KAAK,KAAK,CAAC,CAAf,EAAkB;AAChBA,QAAAA,KAAK,GAAG,CAAR;AACA,aAAKhB,SAAL,GAAiBO,OAAjB;AACD;;AACDO,MAAAA,MAAM,CAACC,IAAD,CAAN,GAAeF,MAAM,CAACG,KAAD,CAArB;AACA/B,MAAAA,6BAA6B,CAAC6B,MAAD,EAASA,MAAM,CAACK,KAAhB,CAA7B;AACD,KATD;AAUD;;AA3BiB;;AA8BpB,eAAe,MAAMC,YAAN,CAAmB;AAChCtB,EAAAA,WAAW,CAACuB,IAAD,EAAO;AAChB,SAAKC,UAAL,GAAkBD,IAAI,CAACC,UAAL,CAAgBC,GAAhB,CAAoB,CAACC,SAAD,EAAYR,KAAZ,KAAsB;AAC1D,YAAMS,IAAI,GAAGD,SAAS,CAACC,IAAV,wBAA+BT,KAA/B,CAAb;AACA,YAAMU,QAAQ,GAAGF,SAAS,CAACE,QAAV,CAAmBH,GAAnB,CAAuB;AAAA,YAAEX,KAAF,SAAEA,KAAF;AAAA,wCAASe,aAAT;AAAA,YAASA,aAAT,oCAAyB,QAAzB;AAAA,YAAmCd,MAAnC,SAAmCA,MAAnC;AAAA,eAAgD;AACtFD,UAAAA,KAAK,EAAEhD,iBAAiB,CAACyD,IAAI,CAACO,SAAL,CAAehB,KAAf,CAAD,CAD8D;AAEtFe,UAAAA,aAFsF;AAGtFd,UAAAA,MAAM,EAAEjD,iBAAiB,CAACyD,IAAI,CAACO,SAAL,CAAef,MAAf,CAAD;AAH6D,SAAhD;AAAA,OAAvB,CAAjB;AAKA,YAAMJ,QAAQ,GAAGe,SAAS,CAACf,QAAV,CAAmBc,GAAnB,CAAuB;AAAA,YAAEZ,OAAF,SAAEA,OAAF;AAAA,YAAWG,MAAX,SAAWA,MAAX;AAAA,eAAwB;AAC9DH,UAAAA,OAAO,EAAEe,QAAQ,CAACf,OAAD,CAD6C;AAE9DG,UAAAA,MAAM,EAAEO,IAAI,CAACQ,KAAL,CAAWf,MAAM,CAAC3B,IAAlB,CAFsD;AAG9D4B,UAAAA,IAAI,EAAED,MAAM,CAACC;AAHiD,SAAxB;AAAA,OAAvB,CAAjB;AAKA,aAAO,IAAIlB,aAAJ,CAAkB;AAAC4B,QAAAA,IAAD;AAAOhB,QAAAA;AAAP,OAAlB,CAAP;AACD,KAbiB,CAAlB;AAcD;;AAEDJ,EAAAA,OAAO,CAACC,MAAD,EAAS;AACd,SAAKgB,UAAL,CAAgBZ,OAAhB,CAAwBc,SAAS,IAAIA,SAAS,CAACnB,OAAV,CAAkBC,MAAlB,CAArC;AACD;;AAEDwB,EAAAA,aAAa,GAAG;AACd,WAAO,KAAKR,UAAZ;AACD;;AAxB+B","sourcesContent":["import {Matrix4} from 'math.gl';\n\n// TODO: import from loaders.gl?\nexport const ATTRIBUTE_TYPE_TO_COMPONENTS = {\n  SCALAR: 1,\n  VEC2: 2,\n  VEC3: 3,\n  VEC4: 4,\n  MAT2: 4,\n  MAT3: 9,\n  MAT4: 16\n};\n\nexport const ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY = {\n  5120: Int8Array,\n  5121: Uint8Array,\n  5122: Int16Array,\n  5123: Uint16Array,\n  5125: Uint32Array,\n  5126: Float32Array\n};\n//\n\nfunction accessorToJsArray(accessor) {\n  if (!accessor._animation) {\n    const ArrayType = ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[accessor.componentType];\n    const components = ATTRIBUTE_TYPE_TO_COMPONENTS[accessor.type];\n    const length = components * accessor.count;\n    const {buffer, byteOffset} = accessor.bufferView.data;\n\n    const array = new ArrayType(buffer, byteOffset + (accessor.byteOffset || 0), length);\n\n    if (components === 1) {\n      accessor._animation = Array.from(array);\n    } else {\n      // Slice array\n      const slicedArray = [];\n      for (let i = 0; i < array.length; i += components) {\n        slicedArray.push(Array.from(array.slice(i, i + components)));\n      }\n      accessor._animation = slicedArray;\n    }\n  }\n\n  return accessor._animation;\n}\n\n// TODO: share with GLTFInstantiator\nconst helperMatrix = new Matrix4();\nfunction applyTranslationRotationScale(gltfNode, node) {\n  node.matrix.identity();\n\n  if (gltfNode.translation) {\n    node.matrix.translate(gltfNode.translation);\n  }\n\n  if (gltfNode.rotation) {\n    const rotationMatrix = helperMatrix.fromQuaternion(gltfNode.rotation);\n    node.matrix.multiplyRight(rotationMatrix);\n  }\n\n  if (gltfNode.scale) {\n    node.matrix.scale(gltfNode.scale);\n  }\n}\n\nclass GLTFAnimation {\n  constructor(props) {\n    this.startTime = 0;\n    this.playing = true;\n    this.speed = 1;\n\n    Object.assign(this, props);\n  }\n\n  animate(timeMs) {\n    if (!this.playing) {\n      return;\n    }\n\n    const absTime = timeMs / 1000;\n    const time = (absTime - this.startTime) * this.speed;\n\n    this.channels.forEach(({sampler: {input, output}, target, path}) => {\n      // TODO: support \"interpolation\"\n      let index = input.findIndex(t => t > time);\n      if (index === -1) {\n        index = 0;\n        this.startTime = absTime;\n      }\n      target[path] = output[index];\n      applyTranslationRotationScale(target, target._node);\n    });\n  }\n}\n\nexport default class GLTFAnimator {\n  constructor(gltf) {\n    this.animations = gltf.animations.map((animation, index) => {\n      const name = animation.name || `Animation-${index}`;\n      const samplers = animation.samplers.map(({input, interpolation = 'LINEAR', output}) => ({\n        input: accessorToJsArray(gltf.accessors[input]),\n        interpolation,\n        output: accessorToJsArray(gltf.accessors[output])\n      }));\n      const channels = animation.channels.map(({sampler, target}) => ({\n        sampler: samplers[sampler],\n        target: gltf.nodes[target.node],\n        path: target.path\n      }));\n      return new GLTFAnimation({name, channels});\n    });\n  }\n\n  animate(timeMs) {\n    this.animations.forEach(animation => animation.animate(timeMs));\n  }\n\n  getAnimations() {\n    return this.animations;\n  }\n}\n"],"file":"gltf-animator.js"}