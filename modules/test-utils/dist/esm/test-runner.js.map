{"version":3,"sources":["../../src/test-runner.js"],"names":["AnimationLoop","pushContextState","popContextState","noop","DEFAULT_TEST_CASE","name","onInitialize","onRender","done","onFinalize","DEFAULT_TEST_OPTIONS","onTestStart","testCase","console","log","onTestPass","onTestFail","timeout","TestRunner","props","isRunning","_testCases","_testCaseData","isHeadless","Boolean","window","browserTestDriver_isHeadless","testOptions","Object","assign","testCases","Array","isArray","push","options","Promise","resolve","_animationLoop","_onRender","bind","start","isDiffing","_currentTestCase","error","_fail","message","animationLoop","key","animationProps","_pass","_next","result","_nextTestCase","_animationProps","stop","isDone","testCaseAnimationProps","startTime","_currentTestCaseStartTime","time","tick","_currentTestCaseStartTick","shouldRender","assert","value","gl","shift","initTestCase","then","userData"],"mappings":"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","sourcesContent":["/* global window, console */\n/* eslint-disable no-console */\nimport {AnimationLoop} from '@luma.gl/core';\nimport {pushContextState, popContextState} from '@luma.gl/webgl-state-tracker';\n\nfunction noop() {}\n\nconst DEFAULT_TEST_CASE = {\n  name: 'Unnamed test',\n  onInitialize: noop,\n  onRender: ({done}) => done(),\n  onFinalize: noop\n};\n\nconst DEFAULT_TEST_OPTIONS = {\n  // test lifecycle callback\n  onTestStart: testCase => console.log(`# ${testCase.name}`),\n  onTestPass: testCase => console.log(`ok ${testCase.name} passed`),\n  onTestFail: testCase => console.log(`not ok ${testCase.name} failed`),\n\n  // milliseconds to wait for each test case before aborting\n  timeout: 2000\n};\n\nexport default class TestRunner {\n  /**\n   * props\n   *   AnimationLoop props\n   */\n  constructor(props = {}) {\n    this.props = props;\n    this.isRunning = false;\n    this._testCases = [];\n    this._testCaseData = null;\n\n    this.isHeadless = Boolean(window.browserTestDriver_isHeadless);\n\n    this.testOptions = Object.assign({}, DEFAULT_TEST_OPTIONS);\n  }\n\n  /**\n   * Add testCase(s)\n   */\n  add(testCases) {\n    if (!Array.isArray(testCases)) {\n      testCases = [testCases];\n    }\n    for (const testCase of testCases) {\n      this._testCases.push(testCase);\n    }\n    return this;\n  }\n\n  /**\n   * Returns a promise that resolves when all the test cases are done\n   */\n  run(options = {}) {\n    Object.assign(this.testOptions, options);\n\n    return new Promise(resolve => {\n      this._animationLoop = new AnimationLoop(\n        Object.assign({}, this.props, {\n          onRender: this._onRender.bind(this),\n          onFinalize: () => {\n            this.isRunning = false;\n            resolve();\n          }\n        })\n      );\n      this._animationLoop.start(this.props);\n\n      this.isRunning = true;\n      this.isDiffing = false;\n      this._currentTestCase = null;\n    }).catch(error => {\n      this._fail({error: error.message});\n    });\n  }\n\n  /* Lifecycle methods for subclassing */\n\n  initTestCase(testCase) {\n    const {animationLoop} = testCase;\n    if (animationLoop) {\n      testCase.onInitialize = animationLoop.onInitialize.bind(animationLoop);\n      testCase.onRender = animationLoop.onRender.bind(animationLoop);\n      testCase.onFinalize = animationLoop.onFinalize.bind(animationLoop);\n    }\n    for (const key in DEFAULT_TEST_CASE) {\n      testCase[key] = testCase[key] || DEFAULT_TEST_CASE[key];\n    }\n  }\n\n  shouldRender(animationProps) {\n    return true;\n  }\n\n  assert(testCase) {\n    this._pass(testCase);\n    this._next();\n  }\n\n  /* Utilities */\n\n  _pass(result) {\n    this.testOptions.onTestPass(this._currentTestCase, result);\n  }\n\n  _fail(result) {\n    this.testOptions.onTestFail(this._currentTestCase, result);\n  }\n\n  _next() {\n    this._nextTestCase();\n  }\n\n  /* Private methods */\n\n  _onRender(animationProps) {\n    this._animationProps = animationProps;\n\n    const testCase = this._currentTestCase || this._nextTestCase();\n    if (!testCase) {\n      // all test cases are done\n      this._animationLoop.stop();\n      return;\n    }\n\n    let isDone = false;\n    const testCaseAnimationProps = Object.assign({}, animationProps, this._testCaseData, {\n      // tick/time starts from 0 for each test case\n      startTime: this._currentTestCaseStartTime,\n      time: animationProps.time - this._currentTestCaseStartTime,\n      tick: animationProps.tick - this._currentTestCaseStartTick,\n      // called by the test case when it is done rendering and ready for capture and diff\n      done: () => {\n        isDone = true;\n      }\n    });\n\n    if (this._testCaseData && this.shouldRender(testCaseAnimationProps)) {\n      // test case is initialized, render frame\n      testCase.onRender(testCaseAnimationProps);\n    }\n\n    const timeout = testCase.timeout || this.testOptions.timeout;\n    if (timeout && testCaseAnimationProps.time > timeout) {\n      isDone = true;\n    }\n\n    if (isDone) {\n      this.assert(testCase);\n    }\n  }\n\n  _nextTestCase() {\n    const animationProps = this._animationProps;\n\n    // finalize the current test case\n    if (this._testCaseData) {\n      for (const key in this._testCaseData) {\n        const value = this._testCaseData[key];\n        if (value && value.delete) {\n          value.delete();\n        }\n      }\n      this._currentTestCase.onFinalize(Object.assign({}, animationProps, this._testCaseData));\n\n      // reset WebGL context\n      popContextState(animationProps.gl);\n\n      this._currentTestCase = null;\n      this._testCaseData = null;\n    }\n\n    // get the next test case\n    const testCase = this._testCases.shift();\n    if (testCase) {\n      // start new test case\n      this._currentTestCase = testCase;\n      this._currentTestCaseStartTime = animationProps.time;\n      this._currentTestCaseStartTick = animationProps.tick;\n      this.initTestCase(testCase);\n\n      // initialize test case\n\n      // save WebGL context\n      pushContextState(animationProps.gl);\n\n      // aligned with the behavior of AnimationLoop.onInitialized\n      // onInitialized could return a plain object or a promise\n      Promise.resolve(\n        testCase.onInitialize(\n          Object.assign({}, animationProps, {\n            // tick/time starts from 0 for each test case\n            startTime: animationProps.time,\n            time: 0,\n            tick: 0\n          })\n        )\n      ).then(userData => {\n        this._testCaseData = userData || {};\n      });\n      // invoke user callback\n      this.testOptions.onTestStart(testCase);\n    }\n    return testCase;\n  }\n}\n"],"file":"test-runner.js"}